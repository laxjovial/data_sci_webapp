{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <h2>Model Building</h2>
            <p>Train and evaluate various machine learning models.</p>
            <div class="card">
                <div class="card-header"><h4>Configure Model</h4></div>
                <div class="card-body">
                    <form action="{{ url_for('modeling') }}" method="post">
                        <div class="mb-3">
                            <label for="model_type" class="form-label">Model Type</label>
                            <select class="form-select" name="model_type" id="model_type" required>
                                <option value="Classification">Classification</option>
                                <option value="Regression">Regression</option>
                                <option value="Clustering">Clustering</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="model_name" class="form-label">Model Name</label>
                            <select class="form-select" name="model_name" id="model_name" required>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="mb-3" id="target-column-model-wrapper">
                            <label for="target_column" class="form-label">Target Column</label>
                            <select class="form-select" name="target_column" id="target_column">
                                {% for c in columns %}<option value="{{c}}">{{c}}</option>{% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Run Model</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <h2>Model Report</h2>
            {% if report %}
                <div class="card">
                    <div class="card-header">
                        <h5>Report for: {{ report.model_name }} ({{ report.model_type }})</h5>
                    </div>
                    <div class="card-body">
                        <h4>Metrics</h4>
                        <ul>
                        {% for metric, value in report.metrics.items() %}
                            <li><strong>{{ metric }}:</strong> {{ "%.4f"|format(value) }}</li>
                        {% endfor %}
                        </ul>
                        <hr>
                        {% if report.confusion_matrix %}
                            <h4>Confusion Matrix</h4>
                            <div id="confusion-matrix-plot"></div>
                        {% endif %}
                        {% if report.regression_plot %}
                            <h4>Regression Plot</h4>
                            <div id="regression-plot"></div>
                        {% endif %}
                         {% if report.cluster_plot %}
                            <h4>Cluster Plot (PCA)</h4>
                            <div id="cluster-plot"></div>
                        {% endif %}
                        {% if report.shap_plot %}
                            <hr>
                            <h4>Feature Importance (SHAP)</h4>
                            {{ report.shap_plot|safe }}
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p>No model report to display. Run a model to see the results.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const models = {{ models|tojson }};
    const modelTypeSelect = document.getElementById('model_type');
    const modelNameSelect = document.getElementById('model_name');
    const targetWrapper = document.getElementById('target-column-model-wrapper');

    function updateModelNames() {
        const selectedType = modelTypeSelect.value;
        modelNameSelect.innerHTML = '';
        models[selectedType].forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            modelNameSelect.appendChild(option);
        });

        if (selectedType === 'Clustering') {
            targetWrapper.style.display = 'none';
        } else {
            targetWrapper.style.display = 'block';
        }
    }

    modelTypeSelect.addEventListener('change', updateModelNames);
    updateModelNames(); // Initial population

    // Render plots if report is available
    {% if report and report.confusion_matrix %}
        const cmPlot = JSON.parse('{{ report.confusion_matrix|safe }}');
        Plotly.newPlot('confusion-matrix-plot', cmPlot.data, cmPlot.layout);
    {% endif %}
    {% if report and report.regression_plot %}
        const regPlot = JSON.parse('{{ report.regression_plot|safe }}');
        Plotly.newPlot('regression-plot', regPlot.data, regPlot.layout);
    {% endif %}
     {% if report and report.cluster_plot %}
        const clusterPlot = JSON.parse('{{ report.cluster_plot|safe }}');
        Plotly.newPlot('cluster-plot', clusterPlot.data, clusterPlot.layout);
    {% endif %}
});
</script>
{% endblock %}
