{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h4>Phase 2: Data Cleaning & Preprocessing</h4>
                <p class="mb-0">
                    <span class="fw-bold">Technical:</span> This module provides robust tools for handling common data quality issues. It includes methods for managing missing values, standardizing formats, and dealing with inconsistencies, ensuring data integrity for subsequent analysis.
                    <br>
                    <span class="fw-bold">Layman:</span> Think of this as your data's "pit stop" for a tune-up. We'll fix messy parts like empty cells, typos, and outliers to make sure your data is clean, reliable, and ready for analysis.
                </p>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger" role="alert"><strong>Error:</strong> {{ error }}</div>
                {% endif %}
                {% if success %}
                <div class="alert alert-success" role="alert"><strong>Success:</strong> {{ success }}</div>
                {% endif %}

                <!-- Data Preview -->
                <div class="mb-4">
                    <h5>Current Data Preview</h5>
                    <div class="table-responsive">
                        {{ df_head|safe }}
                    </div>
                </div>
                <hr>

                <!-- Cleaning Actions -->
                <h5 class="mb-3">Cleaning Actions</h5>
                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-missing" type="button">Handle Missing Values</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-dtype" type="button">Convert Data Type</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-duplicates" type="button">Remove Duplicates</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-text" type="button">Standardize Text</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-outliers" type="button">Handle Outliers</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-inconsistencies" type="button">Correct Inconsistencies</button></li>
                </ul>

                <div class="tab-content border p-3" id="pills-tabContent">
                    <!-- Handle Missing Values -->
                    <div class="tab-pane fade show active" id="pills-missing" role="tabpanel">
                        <form action="{{ url_for('data_cleaning') }}" method="post">
                            <input type="hidden" name="action" value="handle_missing">
                            <p class="form-text">Choose a strategy to deal with empty cells (NaNs) in your data.</p>
                            <div class="mb-3">
                                <label for="missing_cols" class="form-label">Select columns to apply action to:</label>
                                <select class="form-select" name="missing_cols" multiple size="5">
                                    {% for col in columns %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="missing_strategy" class="form-label">Strategy:</label>
                                <select class="form-select" name="missing_strategy">
                                    <option value="drop">Drop rows with any missing values</option>
                                    <option value="mean">Fill with column mean (for numbers)</option>
                                    <option value="median">Fill with column median (for numbers)</option>
                                    <option value="mode">Fill with column mode (most frequent value)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Apply</button>
                        </form>
                    </div>

                    <!-- Convert Data Type -->
                    <div class="tab-pane fade" id="pills-dtype" role="tabpanel">
                        <form action="{{ url_for('data_cleaning') }}" method="post">
                            <input type="hidden" name="action" value="convert_dtype">
                            <p class="form-text">Change the data type of a column (e.g., from text to numbers).</p>
                             <div class="mb-3">
                                <label for="dtype_col" class="form-label">Column to Convert:</label>
                                <select class="form-select" name="dtype_col">
                                    {% for col in columns %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="new_dtype" class="form-label">New Data Type:</label>
                                <select class="form-select" name="new_dtype">
                                    <option value="int64">Integer (Whole Number)</option>
                                    <option value="float64">Float (Decimal Number)</option>
                                    <option value="object">Object (Text)</option>
                                    <option value="datetime">Datetime</option>
                                    <option value="category">Category (for distinct values)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Apply</button>
                        </form>
                    </div>

                    <!-- Remove Duplicates -->
                    <div class="tab-pane fade" id="pills-duplicates" role="tabpanel">
                        <form action="{{ url_for('data_cleaning') }}" method="post">
                            <input type="hidden" name="action" value="remove_duplicates">
                            <p class="form-text">Remove identical rows from your dataset.</p>
                            <button type="submit" class="btn btn-success">Remove All Duplicate Rows</button>
                        </form>
                    </div>

                    <!-- Standardize Text -->
                    <div class="tab-pane fade" id="pills-text" role="tabpanel">
                         <form action="{{ url_for('data_cleaning') }}" method="post">
                            <input type="hidden" name="action" value="standardize_text">
                            <p class="form-text">Clean up text columns by making them consistent (e.g., all lowercase).</p>
                            <div class="mb-3">
                                <label for="text_col" class="form-label">Column to Standardize:</label>
                                <select class="form-select" name="text_col">
                                    {% for col in columns %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                                </select>
                            </div>
                             <div class="mb-3">
                                <label for="text_case" class="form-label">Case:</label>
                                <select class="form-select" name="text_case">
                                    <option value="lower">Lowercase</option>
                                    <option value="upper">Uppercase</option>
                                    <option value="title">Title Case</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Apply</button>
                        </form>
                    </div>

                    <!-- Handle Outliers -->
                    <div class="tab-pane fade" id="pills-outliers" role="tabpanel">
                        <form action="{{ url_for('data_cleaning') }}" method="post">
                            <input type="hidden" name="action" value="handle_outliers">
                            <p class="form-text">Manage extreme values (outliers) that can skew analysis.</p>
                            <div class="mb-3">
                                <label for="outlier_col" class="form-label">Select Numeric Column:</label>
                                <select class="form-select" name="outlier_col">
                                    {% for col in columns %}{% if df[col].dtype in ['int64', 'float64'] %}<option value="{{ col }}">{{ col }}</option>{% endif %}{% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="outlier_method" class="form-label">Method:</label>
                                <select class="form-select" name="outlier_method">
                                    <option value="remove">Remove Outlier Rows (using IQR)</option>
                                    <option value="cap">Cap Outliers (replace with boundary values)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Apply</button>
                        </form>
                    </div>

                    <!-- Correct Inconsistencies -->
                    <div class="tab-pane fade" id="pills-inconsistencies" role="tabpanel">
                        <form action="{{ url_for('data_cleaning') }}" method="post">
                            <input type="hidden" name="action" value="correct_inconsistencies">
                            <p class="form-text">Fix typos or inconsistent values by providing a mapping (e.g., 'USA' -> 'United States').</p>
                            <div class="mb-3">
                                <label for="inconsistency_col" class="form-label">Column to Correct:</label>
                                <select class="form-select" name="inconsistency_col">
                                    {% for col in columns %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="mapping_dict" class="form-label">Mapping Dictionary:</label>
                                <input type="text" class="form-control" name="mapping_dict" placeholder="{'old_val': 'new_val', 'typo': 'correct'}">
                                <div class="form-text">Enter a Python dictionary. Example: <code>{'N/A': 'Unknown', 'us': 'USA'}</code></div>
                            </div>
                            <button type="submit" class="btn btn-success">Apply</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
